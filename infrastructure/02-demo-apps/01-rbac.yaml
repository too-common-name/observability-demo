# ========================================================
# 1. SERVICE ACCOUNTS
# ========================================================
apiVersion: v1
kind: ServiceAccount
metadata:
  name: otel-app-collector-deployment
  namespace: observability-demo
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: otel-infra-collector-deployment
  namespace: observability-demo
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: perses-sa
  namespace: observability-demo

---
# ========================================================
# 2. PERSES TOKEN (For Datasource Config)
# ========================================================
apiVersion: v1
kind: Secret
metadata:
  name: perses-sa-token
  namespace: observability-demo
  annotations:
    kubernetes.io/service-account.name: perses-sa
type: kubernetes.io/service-account-token

---
# ========================================================
# 3. APP COLLECTOR: Read Metadata (Local Namespace)
# ========================================================
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: otel-app-discovery-role
  namespace: observability-demo
rules:
- apiGroups: [""]
  resources: ["pods", "namespaces", "nodes", "endpoints", "services"]
  verbs: ["get", "watch", "list"]
- apiGroups: ["apps"]
  resources: ["replicasets", "deployments", "statefulsets"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["kubevirt.io"]
  resources: ["virtualmachineinstances"]
  verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: otel-app-discovery-binding
  namespace: observability-demo
subjects:
- kind: ServiceAccount
  name: otel-app-collector-deployment
  namespace: observability-demo
roleRef:
  kind: Role
  name: otel-app-discovery-role
  apiGroup: rbac.authorization.k8s.io

---
# ========================================================
# 4. APP COLLECTOR: Write Metrics (UWM)
# ========================================================
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: otel-app-metrics-writer
subjects:
  - kind: ServiceAccount
    name: otel-app-collector-deployment
    namespace: observability-demo
roleRef:
  kind: ClusterRole
  name: monitoring-metrics-writer
  apiGroup: rbac.authorization.k8s.io

---
# ========================================================
# 5. APP COLLECTOR: Write Traces (Tempo)
# ========================================================
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: tempostack-traces-write-rbac
rules:
  - apiGroups: ['tempo.grafana.com']
    resources: ['demo', 'dev', 'prod']
    resourceNames: ['traces']
    verbs: ['create']
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: tempostack-traces-write-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: tempostack-traces-write-rbac
subjects:
  - kind: ServiceAccount
    name: otel-app-collector-deployment
    namespace: observability-demo

---
# ========================================================
# 6. APP COLLECTOR: Write Logs (Loki)
# ========================================================
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: logging-collector-logs-writer 
rules:
- apiGroups:
  - loki.grafana.com
  resourceNames:
  - logs
  resources:
  - application
  - audit
  - infrastructure
  verbs:
  - create
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: otel-app-collector-logs-writer
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: logging-collector-logs-writer 
subjects:
  - kind: ServiceAccount
    name: otel-app-collector-deployment
    namespace: observability-demo

---
# ========================================================
# 7. PERSES: Read Metrics (Thanos)
# ========================================================
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: perses-platform-reader
subjects:
  - kind: ServiceAccount
    name: perses-sa
    namespace: observability-demo
roleRef:
  kind: ClusterRole
  name: cluster-monitoring-view
  apiGroup: rbac.authorization.k8s.io

---
# ========================================================
# 8. INFRA COLLECTOR: Read Node Stats
# ========================================================
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: otel-infra-collector-full-access
rules:
- apiGroups: [""]
  resources: ["nodes", "nodes/proxy", "nodes/metrics", "nodes/stats"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["pods", "namespaces", "services", "endpoints"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources: ["replicasets", "deployments"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["kubevirt.io"]
  resources: ["virtualmachineinstances", "virtualmachineinstances/status"]
  verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: otel-infra-collector-full-binding
subjects:
- kind: ServiceAccount
  name: otel-infra-collector-deployment
  namespace: observability-demo
roleRef:
  kind: ClusterRole
  name: otel-infra-collector-full-access
  apiGroup: rbac.authorization.k8s.io