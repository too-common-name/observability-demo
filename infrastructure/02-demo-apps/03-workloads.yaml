# ========================================================
# 1. QUARKUS BACKEND
# ========================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: quarkus-backend
  namespace: observability-demo
  labels:
    app: quarkus-backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: quarkus-backend
  template:
    metadata:
      labels:
        app: quarkus-backend
      annotations:
        instrumentation.opentelemetry.io/inject-java: "true"
    spec:
      containers:
        - name: quarkus
          image: quay.io/rh-developers/quarkus-demo:latest
          securityContext:
            capabilities:
              drop:
                - ALL
            runAsUser: 1000940000
            runAsNonRoot: true
            allowPrivilegeEscalation: false
          ports:
            - name: http
              containerPort: 8081
              protocol: TCP
          resources:
            requests:
              memory: "256Mi"
              cpu: "250m"
            limits:
              memory: "1Gi"
              cpu: "1000m"
---
apiVersion: v1
kind: Service
metadata:
  name: quarkus-backend
  namespace: observability-demo
spec:
  selector:
    app: quarkus-backend
  ports:
    - port: 8080
      targetPort: 8081
---
# ========================================================
# 2. TOMCAT FRONTEND (Virtual Machine)
# ========================================================
apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  name: frontend-tomcat-vm
  namespace: observability-demo
  labels:
    app: frontend-tomcat-service
    vm.kubevirt.io/name: frontend-tomcat-service
spec:
  running: true
  template:
    metadata:
      labels:
        app: frontend-tomcat-service
        vm.kubevirt.io/name: frontend-tomcat-service
    spec:
      domain:
        devices:
          disks:
            - disk:
                bus: virtio
              name: containerdisk
            - disk:
                bus: virtio
              name: cloudinitdisk
          interfaces:
            - name: default
              masquerade: {}
        resources:
          requests:
            memory: 2Gi
      networks:
        - name: default
          pod: {}
      volumes:
        - name: containerdisk
          containerDisk:
            image: quay.io/containerdisks/fedora:latest
        - name: cloudinitdisk
          cloudInitNoCloud:
            userData: |
              #cloud-config
              packages:
                - java-17-openjdk
                - tomcat
                - wget

              write_files:
                # 1. Configure OTel Agent
                - path: /usr/share/tomcat/conf/conf.d/java_opts.conf
                  content: |
                    JAVA_OPTS="$JAVA_OPTS -javaagent:/usr/share/java/opentelemetry-javaagent.jar"
                    JAVA_OPTS="$JAVA_OPTS -Dotel.service.name=frontend-tomcat-service"
                    JAVA_OPTS="$JAVA_OPTS -Dotel.exporter.otlp.endpoint=http://otel-collector.observability-demo.svc.cluster.local:4317"
                    JAVA_OPTS="$JAVA_OPTS -Dotel.traces.exporter=otlp"
                    JAVA_OPTS="$JAVA_OPTS -Dotel.metrics.exporter=otlp"

              runcmd:
                # 2. Download OTel Agent
                - wget https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases/latest/download/opentelemetry-javaagent.jar -O /usr/share/java/opentelemetry-javaagent.jar
                - chmod 644 /usr/share/java/opentelemetry-javaagent.jar
                
                # 3. Deploy App from GitHub Artifacts
                - rm -rf /var/lib/tomcat/webapps/ROOT
                # REPLACE THE URL BELOW with your actual GitHub Release URL
                - wget https://github.com/YOUR_ORG/YOUR_REPO/releases/download/v1.0.0/ROOT.war -O /var/lib/tomcat/webapps/ROOT.war
                - chown tomcat:tomcat /var/lib/tomcat/webapps/ROOT.war

                # 4. Start Tomcat
                - systemctl enable --now tomcat
---
apiVersion: v1
kind: Service
metadata:
  name: frontend-tomcat-service
  namespace: observability-demo
spec:
  selector:
    app: frontend-tomcat-service
  ports:
    - port: 8080
      targetPort: 8080
---
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: frontend-tomcat-service
  namespace: observability-demo
spec:
  to:
    kind: Service
    name: frontend-tomcat-service
  port:
    targetPort: 8080
  tls:
    termination: edge