---
apiVersion: v1
kind: ConfigMap
metadata:
  name: tempo-mcp-adapter-config
  namespace: openshift-tracing
data:
  nginx.conf: |
    pid /tmp/nginx.pid;
    events {}
    http {
      client_body_temp_path /tmp/client_temp;
      proxy_temp_path       /tmp/proxy_temp_path;
      fastcgi_temp_path     /tmp/fastcgi_temp;
      uwsgi_temp_path       /tmp/uwsgi_temp;
      scgi_temp_path        /tmp/scgi_temp;

      server {
        listen 8080;
        location / {
          proxy_pass https://tempo-platform-query-frontend.openshift-tracing.svc:3200;
          
          # 1. IDENTITY: Use the cert generated by your script
          proxy_ssl_certificate /etc/nginx/certs/tls.crt;
          proxy_ssl_certificate_key /etc/nginx/certs/tls.key;
          
          # 2. VERIFICATION: Use the Tempo CA to verify the server
          #    (We mount the secret containing the CA here)
          proxy_ssl_trusted_certificate /etc/nginx/trusted-ca/tls.crt;
          proxy_ssl_verify on;
          proxy_ssl_name tempo-platform-query-frontend.openshift-tracing.svc.cluster.local;
        }
      }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tempo-mcp-adapter
  namespace: openshift-tracing
spec:
  replicas: 1
  selector:
    matchLabels:
      app: tempo-mcp-adapter
  template:
    metadata:
      labels:
        app: tempo-mcp-adapter
    spec:
      containers:
      - name: nginx
        image: nginx:alpine
        resources:
          requests:
            cpu: 30m
            memory: 100Mi
          limits:
            cpu: 120m
            memory: 250Mi
        ports:
        - containerPort: 8080
        volumeMounts:
        - name: config
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
        - name: certs
          mountPath: /etc/nginx/certs
        - name: trusted-ca-volume
          mountPath: /etc/nginx/trusted-ca
          readOnly: true
        - name: tmp-volume
          mountPath: /tmp
        - name: cache-volume
          mountPath: /var/cache/nginx
      volumes:
      - name: config
        configMap:
          name: tempo-mcp-adapter-config
      - name: certs
        secret:
          secretName: mcp-adapter-mtls
      - name: trusted-ca-volume
        secret:
          secretName: tempo-platform-signing-ca
      - name: tmp-volume
        emptyDir: {}
      - name: cache-volume
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: tempo-mcp-adapter
  namespace: openshift-tracing
spec:
  ports:
  - port: 80
    targetPort: 8080
  selector:
    app: tempo-mcp-adapter